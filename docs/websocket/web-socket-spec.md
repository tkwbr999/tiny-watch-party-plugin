# WebSocket機能仕様書

## 更新履歴
- 2024-12-XX: 初版作成

## 1. システム概要
- **実装方式**: ルームキー方式（10桁A-Z）
- **ライフサイクル**: 最大3時間、無人5分で自動終了
- **技術スタック**: Cloudflare Workers + Durable Objects + D1 Database

## 2. 技術仕様

### 2.1 ルームキー仕様
- **形式**: `[A-Z]{10}` (英大文字10桁)
- **例**: `HKPQWERTYU`
- **生成**: ランダム生成
- **衝突処理**: 重複検知時は再生成
- **有効期間**: 最大3時間

### 2.2 タイムアウト管理
- **無人検知**: 5分間参加者0人で自動終了
- **最大稼働**: 3時間で強制終了
- **ハートビート**: 30秒間隔で生存確認
- **警告通知**: 終了5分前にアラート送信

### 2.3 課金対策
- **WebSocket起動**: 参加者がいる間のみ
- **Durable Objects**: 無人時は5分で削除
- **データベース**: TTL設定で自動削除
- **無料枠活用**: Cloudflare無料プランでの運用

## 3. データ構造

### 3.1 ルーム情報
```javascript
{
  roomKey: "HKPQWERTYU",
  createdAt: "2024-01-20T10:00:00Z",
  expiresAt: "2024-01-20T13:00:00Z",  // 3時間後
  hostId: "host-unique-id",
  participantCount: 3,
  status: "active",  // active, idle, closed
  lastActivity: "2024-01-20T10:30:00Z"
}
```

### 3.2 メッセージ構造
```javascript
{
  id: "msg-12345",
  roomKey: "HKPQWERTYU",
  userId: "user-abc123",
  message: "こんにちは！",
  timestamp: 1234567890,
  type: "message"  // message, system, notification
}
```

### 3.3 参加者情報
```javascript
{
  userId: "user-abc123",
  roomKey: "HKPQWERTYU",
  joinedAt: "2024-01-20T10:15:00Z",
  lastSeen: "2024-01-20T10:30:00Z",
  status: "online"  // online, away, offline
}
```

## 4. WebSocket API仕様

### 4.1 接続エンドポイント
```
wss://tiny-watch-party.[account].workers.dev/room/{roomKey}
```

### 4.2 メッセージフォーマット

#### 送信メッセージ
```json
{
  "type": "MESSAGE",
  "data": {
    "text": "メッセージ内容",
    "userId": "user-abc123"
  },
  "timestamp": 1234567890
}
```

#### 受信メッセージ
```json
{
  "type": "MESSAGE|JOIN|LEAVE|HEARTBEAT|ROOM_CLOSED",
  "data": {
    "message": "メッセージ内容",
    "userId": "user-abc123",
    "userName": "ユーザー名"
  },
  "timestamp": 1234567890,
  "messageId": "msg-12345"
}
```

### 4.3 システムメッセージタイプ
- `JOIN`: ユーザー参加通知
- `LEAVE`: ユーザー退出通知
- `HEARTBEAT`: 生存確認
- `ROOM_CLOSED`: ルーム終了通知
- `HISTORY`: 過去ログ取得
- `ERROR`: エラー通知

### 4.4 エラーコード
- `E001`: 無効なルームキー
- `E002`: ルーム満室（将来実装）
- `E003`: ルームが存在しない
- `E004`: ルーム有効期限切れ
- `E005`: サーバー内部エラー

## 5. UI要件

### 5.1 初期画面（ルーム未参加）
- [ ] 「ウォッチパーティーを開始」ボタン
- [ ] ルームキー入力欄（10桁、A-Z制限）
- [ ] 「参加」ボタン
- [ ] 入力バリデーション表示

### 5.2 ルーム内画面
- [ ] ルームキー表示
- [ ] 「キーをコピー」ボタン
- [ ] 残り時間表示
- [ ] 参加者数表示
- [ ] 「退出」ボタン
- [ ] チャットタイムライン

### 5.3 チャット機能
- [ ] メッセージ表示（タイムスタンプ付き）
- [ ] メッセージ入力欄
- [ ] 送信ボタン（Ctrl+Enter対応）
- [ ] スクロール機能
- [ ] 自動スクロール（新着時）

## 6. セキュリティ要件

### 6.1 認証・認可
- ルームキーベース認証
- ユーザーID生成（Chrome拡張機能側）
- 不正なルームキーの拒否

### 6.2 レート制限
- メッセージ送信: 5秒に1回
- ルーム作成: 1分に1回
- 再接続試行: 指数バックオフ

### 6.3 データ保護
- メッセージの自動削除（TTL）
- 個人情報の非保存
- WebSocket通信の暗号化

## 7. パフォーマンス要件

### 7.1 応答時間
- メッセージ送信遅延: 100ms以下
- ルーム作成時間: 500ms以下
- 過去ログ取得: 1秒以下

### 7.2 同時接続数
- Phase 1: 10ルーム×5人 = 50接続
- Phase 2: 100ルーム×10人 = 1000接続
- 無料枠での運用限界を考慮

### 7.3 メッセージ保存
- 1ルームあたり最大1000件
- 過去3時間分のみ保持
- 自動削除でストレージ節約

## 8. 今後の検討事項

### Phase 1完了後の機能
- [ ] 最大参加人数制限
- [ ] ホスト権限の移譲機能
- [ ] メッセージ削除機能
- [ ] 絵文字リアクション
- [ ] タイピングインジケーター

### Phase 2以降の機能
- [ ] ルーム設定（公開/非公開）
- [ ] ユーザーニックネーム
- [ ] 動画同期再生機能
- [ ] タイムスタンプ付きコメント
- [ ] ルーム内投票機能

## 9. 変更ログ

### [日付] - [バージョン]
**追加**:
- [機能名]: [詳細説明]

**修正**:
- [不具合内容]: [修正内容]

**削除**:
- [削除機能]: [削除理由]

**変更**:
- [変更内容]: [変更理由]

---

## 10. 備考

### 開発メモ
- この仕様書は実装中に随時更新する
- 新機能追加時は必ずこのドキュメントを更新
- 変更ログは必須で記録する

### 技術的制約
- Cloudflare Workers無料枠: 100,000リクエスト/日
- Durable Objects: 1,000,000リクエスト/月
- D1 Database: 5GB、100,000,000読み取り/日
- WebSocket接続時間による課金なし（2024年時点）