# WebSocket機能仕様書

## 更新履歴
- 2024-12-XX: 初版作成
- 2024-12-XX: セキュリティ仕様を強化、Chrome拡張機能制約を明記

## 1. システム概要
- **実装方式**: ルームキー方式（12-16桁英数字、セキュリティ強化）
- **ライフサイクル**: 最大3時間、無人5分で自動終了
- **技術スタック**: Cloudflare Workers + Durable Objects + D1 Database
- **セキュリティ**: 多層防御アーキテクチャ、異常検知・自動遮断
- **Chrome拡張対応**: Service Worker対応（Chrome 116以降）

## 2. 技術仕様

### 2.1 ルームキー仕様（セキュリティ強化）
- **形式**: `[A-Z0-9]{12,16}` (英数字12-16桁)
- **例**: `HKPQ9W8E7RTY23UV` (16桁)
- **生成**: crypto.getRandomValues()使用（セキュアな乱数）
- **衝突処理**: 重複検知時は再生成（最大5回試行）
- **有効期間**: 最大3時間
- **推測困難性**: 約62^12 ≈ 3.2×10^21通り（12桁最小）
- **禁止パターン**: 連続文字、順序パターン、辞書攻撃対策

### 2.2 タイムアウト管理
- **無人検知**: 5分間参加者0人で自動終了
- **最大稼働**: 3時間で強制終了
- **ハートビート**: 30秒間隔で生存確認
- **警告通知**: 終了5分前にアラート送信

### 2.3 セキュリティ・課金対策
- **WebSocket起動**: 参加者がいる間のみ
- **Durable Objects**: 無人時は5分で削除
- **データベース**: TTL設定で自動削除
- **無料枠活用**: Cloudflare無料プランでの運用
- **レート制限**: 1IP当たり10接続/分、メッセージ2秒間隔
- **異常検知**: 無効ルームキー3回で5分間IPブロック
- **緊急遮断**: 管理コンソールでの即座サービス停止機能

## 3. データ構造

### 3.1 ルーム情報
```javascript
{
  roomKey: "HKPQWERTYU",
  createdAt: "2024-01-20T10:00:00Z",
  expiresAt: "2024-01-20T13:00:00Z",  // 3時間後
  hostId: "host-unique-id",
  participantCount: 3,
  status: "active",  // active, idle, closed
  lastActivity: "2024-01-20T10:30:00Z"
}
```

### 3.2 メッセージ構造
```javascript
{
  id: "msg-12345",
  roomKey: "HKPQWERTYU",
  userId: "user-abc123",
  message: "こんにちは！",
  timestamp: 1234567890,
  type: "message"  // message, system, notification
}
```

### 3.3 参加者情報
```javascript
{
  userId: "user-abc123",
  roomKey: "HKPQWERTYU",
  joinedAt: "2024-01-20T10:15:00Z",
  lastSeen: "2024-01-20T10:30:00Z",
  status: "online"  // online, away, offline
}
```

## 4. WebSocket API仕様

### 4.1 接続エンドポイント
```
wss://tiny-watch-party.[account].workers.dev/room/{roomKey}
```

### 4.2 メッセージフォーマット

#### 送信メッセージ
```json
{
  "type": "MESSAGE",
  "data": {
    "text": "メッセージ内容",
    "userId": "user-abc123"
  },
  "timestamp": 1234567890
}
```

#### 受信メッセージ
```json
{
  "type": "MESSAGE|JOIN|LEAVE|HEARTBEAT|ROOM_CLOSED",
  "data": {
    "message": "メッセージ内容",
    "userId": "user-abc123",
    "userName": "ユーザー名"
  },
  "timestamp": 1234567890,
  "messageId": "msg-12345"
}
```

### 4.3 システムメッセージタイプ
- `JOIN`: ユーザー参加通知
- `LEAVE`: ユーザー退出通知
- `HEARTBEAT`: 生存確認
- `ROOM_CLOSED`: ルーム終了通知
- `HISTORY`: 過去ログ取得
- `ERROR`: エラー通知

### 4.4 エラーコード
- `E001`: 無効なルームキー
- `E002`: ルーム満室（将来実装）
- `E003`: ルームが存在しない
- `E004`: ルーム有効期限切れ
- `E005`: サーバー内部エラー

## 5. UI要件

### 5.1 初期画面（ルーム未参加）
- [ ] 「ウォッチパーティーを開始」ボタン
- [ ] ルームキー入力欄（10桁、A-Z制限）
- [ ] 「参加」ボタン
- [ ] 入力バリデーション表示

### 5.2 ルーム内画面
- [ ] ルームキー表示
- [ ] 「キーをコピー」ボタン
- [ ] 残り時間表示
- [ ] 参加者数表示
- [ ] 「退出」ボタン
- [ ] チャットタイムライン

### 5.3 チャット機能
- [ ] メッセージ表示（タイムスタンプ付き）
- [ ] メッセージ入力欄
- [ ] 送信ボタン（Ctrl+Enter対応）
- [ ] スクロール機能
- [ ] 自動スクロール（新着時）

## 6. セキュリティ要件（強化版）

### 6.1 Chrome拡張機能特有の制約
- **エンドポイント露出**: コード内のWebSocket URLは必ず露出される
- **環境変数不可**: ブラウザ環境では環境変数にアクセス不可
- **Service Worker制約**: Chrome 116以降でWebSocket対応、30秒keepAlive必須
- **設定管理**: 拡張機能内でchrome.storage.local使用

### 6.2 多層防御アーキテクチャ
- **レベル1 - エンドポイント層**
  - User-Agent検証（Chrome拡張機能のみ許可）
  - Origin検証（許可ドメインのみ）
  - IPレート制限（1IP当たり10接続/分）

- **レベル2 - 認証・認可層**
  - ルームキー強化検証（12-16桁英数字）
  - 禁止パターン検知（連続文字、順序パターン）
  - ユーザーID生成（Chrome拡張機能側）

- **レベル3 - 異常検知・自動遮断層**
  - 無効ルームキー3回で5分間IPブロック
  - メッセージ送信レート監視（2秒間隔）
  - 同時接続数制限（緊急時の自動スロットリング）

### 6.3 緊急時対応システム
- **キルスイッチ**: 全サービスの即座停止
- **IPブロックリスト**: 悪意のIPの手動ブロック
- **URLローテーション**: 複数エンドポイントでのフェイルオーバー
- **メンテナンスモード**: 一時的なサービス中断

### 6.4 モニタリング・アラート
- **重要指標**: 同時接続数、エラー率、レスポンス時間
- **自動アラート**: Cloudflare Analytics → Webhook → 通知
- **闾値設定**: 1分間に100接続超過でアラート

### 6.5 データ保護強化
- **メッセージ自動削除**: 3時間後TTLで完全削除
- **個人情報非保存**: ユーザーID以外の情報不収集
- **通信暗号化**: WSS必須、TLS 1.3推奨
- **ログ保存**: セキュリティインシデントのみ7日間保存

## 7. パフォーマンス要件

### 7.1 応答時間
- メッセージ送信遅延: 100ms以下
- ルーム作成時間: 500ms以下
- 過去ログ取得: 1秒以下

### 7.2 同時接続数
- Phase 1: 10ルーム×5人 = 50接続
- Phase 2: 100ルーム×10人 = 1000接続
- 無料枠での運用限界を考慮

### 7.3 メッセージ保存
- 1ルームあたり最大1000件
- 過去3時間分のみ保持
- 自動削除でストレージ節約

## 8. 実装ロードマップ（セキュリティ重視）

### Phase 0: セキュリティ基盤
- [ ] 脅威モデリング実施
- [ ] セキュリティテストケース作成
- [ ] 異常検知システム実装
- [ ] 緊急時対応手順策定

### Phase 1: MVP機能（セキュリティ強化版）
- [ ] ルーム作成・参加機能（強化キー検証）
- [ ] WebSocket接続管理（Chrome 116対応）
- [ ] メッセージ送受信（レート制限付）
- [ ] タイムアウト処理（5分無人、3時間最大）
- [ ] 多層防御システム実装

### Phase 2: 本格運用機能
- [ ] 最大参加人数制限（20名）
- [ ] ホスト権限の移譲機能
- [ ] メッセージ削除機能
- [ ] モニタリングダッシュボード
- [ ] インシデント対応自動化

### Phase 3: 高度な機能
- [ ] ルーム設定（公開/非公開）
- [ ] ユーザーニックネーム
- [ ] 動画同期再生機能
- [ ] 統計・分析機能

## 9. 変更ログ

### [日付] - [バージョン]
**追加**:
- [機能名]: [詳細説明]

**修正**:
- [不具合内容]: [修正内容]

**削除**:
- [削除機能]: [削除理由]

**変更**:
- [変更内容]: [変更理由]

---

## 10. 重要な技術的制約と対応

### Chrome拡張機能特有の制約
- **エンドポイント露出**: 不可避、サーバー側防御に依存
- **環境変数不可**: chrome.storage.localで設定管理
- **Service Worker制約**: Chrome 116+、keepAliveメッセージ30秒間隔
- **デバッグ困難**: ローカル開発環境の制約

### プラットフォーム制約（Cloudflare）
- **無料枠**: 100,000リクエスト/日
- **Durable Objects**: 1,000,000リクエスト/月
- **D1 Database**: 5GB、100,000,000読み取り/日
- **WebSocket**: 接続時間課金なし（2024年時点）

### セキュリティ対応方針
- **開発段階**: 最小限のセキュリティで動作確認
- **テスト段階**: IPホワイトリスト or 簡易認証
- **本格運用**: 完全な多層防御システム

### 開発メモ
- この仕様書は実装中に随時更新する
- セキュリティインシデントは必ず記録し更新
- 新機能追加時はセキュリティ影響を評価

---

## 関連ドキュメント

- **セキュリティ詳細**: [02-security-guidelines.md](./02-security-guidelines.md)
- **プラットフォーム選択**: [03-platform-comparison.md](./03-platform-comparison.md)
- **環境構築**: [04-platform-setup.md](./04-platform-setup.md)
- **実装詳細**: [05-use-case-implementation.md](./05-use-case-implementation.md)